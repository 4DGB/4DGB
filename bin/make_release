#!/bin/bash

PROJECT=nothing

if [ $# -ne 2 ]; then
    echo "ERROR: must provide 'project' and 'port' arguments"
    echo "Example:"
    echo " "
    echo "   make_release <project> <port>" 
    echo " "
    exit
else
    PROJECT=$1
    PORT=$2
fi

echo ""
echo "Making a release for project '$PROJECT' ..." 

# initialize the database
echo ""
echo "Initializing database ..."
./bin/db_pop projects/$PROJECT

echo ""
echo "Cleaning release ..."
# clean up
rm -rf release/$PROJECT

echo ""
echo "Creating new release ..."
# new install
mkdir release
mkdir release/$PROJECT
mkdir release/$PROJECT/static

pushd release/$PROJECT 2>&1 >/dev/null
pwd
cp ../../src/gtk/py/gtkserver.py .

# update settings to be this project
cp ../../src/settings/template.webhost.yaml webhost.yaml
sed -i.bak "s/<project>/${PROJECT}/" webhost.yaml
sed -i.bak "s/<port>/${PORT}/" webhost.yaml
rm -f webhost.yaml.bak

# update settings to be this project
cp ../../src/settings/template.localhost.yaml localhost.yaml
sed -i.bak "s/<project>/${PROJECT}/" localhost.yaml
sed -i.bak "s/<port>/${PORT}/" localhost.yaml
rm -f localhost.yaml.bak

cp ../../src/*html static
cp -rf ../../src/gtk static
cp -rf ../../src/img static
cp -rf ../../projects static
cp -rf ../../src/third_party static

# install the python module and test script
echo ""
echo "Installing python module and creating package ..."
mkdir python
pushd python 2>&1 >/dev/null
cp -rf ../../../src/gentk . 
mv gentk/setup.py .
mv gentk/readme.md . 
python setup.py sdist
echo "to upload python module: twine upload dist/*"
cp -rf ../../../test/test-gentk .
popd 2>&1 >/dev/null

popd 2>&1 >/dev/null
